= Merge
:toc:
:toc-title: 목차

== 개요
*Oracle*  + 
Merge : 하나의 쿼리로 대상 테이블에 특정 조건에 따라 다른 쿼리(INSERT, UPDATE, DELETE)를 수행하도록 할 수 있습니다. + 
 + 
*PostgreSQL* + 
INSERT ON CONFLICT : INSERT시에 제약조건 충돌이 발생할 경우, 충돌이 발생한 값에 대해서 아무것도 하지 않거나 UPDATE를 하도록 지정할 수 있습니다.


== 예시

=== Oracle
[source, sql]
----
CREATE TABLE EMP_BONUS (EMPLOYEE_ID NUMERIC, BONUS_YEAR VARCHAR2 (4), SALARY NUMERIC, BONUS NUMERIC, PRIMARY KEY (EMPLOYEE_ID, BONUS_YEAR));

MERGE INTO EMP_BONUS E1
USING (SELECT EMPLOYEE_ID, FIRST_NAME, SALARY, DEPARTMENT_ID FROM EMPLOYEES) E2 ON (E1.EMPLOYEE_ID = E2.EMPLOYEE_ID) 
WHEN MATCHED THEN 
UPDATE SET E1.BONUS = E2.SALARY * 0.5
DELETE WHERE (E1.SALARY >= 10000)
WHEN NOT MATCHED THEN 
INSERT (E1.EMPLOYEE_ID, E1.BONUS_YEAR, E1.SALARY, E1.BONUS) 
VALUES(E2.EMPLOYEE_ID, EXTRACT (YEAR FROM SYSDATE), E2.SALARY, E2.SALARY * 0.5)
WHERE (E2.SALARY < 10000);

----

=== PostgreSQL
[source, sql]
----
CREATE TABLE EMP_BONUS (EMPLOYEE_ID NUMERIC, BONUS_YEAR VARCHAR2 (4), SALARY NUMERIC, BONUS NUMERIC, PRIMARY KEY (EMPLOYEE_ID, BONUS_YEAR));

INSERT INTO EMP_BONUS (EMPLOYEE_ID, BONUS_YEAR, SALARY) 
SELECT EMPLOYEE_ID, EXTRACT(YEAR FROM NOW()), SALARY FROM EMPLOYEES
WHERE SALARY < 10000
ON CONFLICT (EMPLOYEE_ID, BONUS_YEAR)
DO UPDATE SET BONUS = EMP_BONUS.SALARY * 0.5;
----


== 전환방법
- *호환성 : 높음* 

*변환 방법* + 
기능적인 부분이 비슷하기 때문에, 대부분 변환 가능합니다. + 
PostgreSQL 문법에 맞게 재작성 해야합니다.
자세한 문법은 xref:https://www.postgresql.org/docs/14/sql-insert.html#[INSERT]항목을 참고

